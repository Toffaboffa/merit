<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Slutlig antagning – parser (filuppladdning)</title>
  <link rel="icon" href="data:," />
  <style>
    :root{ --bg:#0b0f14; --fg:#e7effa; --muted:#94a3b8; --panel:#0f172a; --accent:#22c55e; --border:#1f2937; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:16px 20px;background:#0f172a;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:2}
    main{max-width:1100px;margin:0 auto;padding:20px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type=file]{flex:1;min-width:260px;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0f172a;color:var(--fg)}
    button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#05280f;font-weight:700;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:20px;background:#0f172a;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{background:#0d1326;position:sticky;top:88px}
    tr:hover td{background:#0c1222}
    .muted{color:var(--muted)}
    details{margin-top:14px}
    pre{white-space:pre-wrap;font-size:12px;background:#0f172a;border:1px solid var(--border);padding:10px;border-radius:8px;max-height:480px;overflow:auto}
    .toolbar{display:flex;gap:8px;margin-top:10px}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#0d1326;border:1px solid #1f2937;border-radius:999px;padding:4px 10px;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <input id="pdfFile" type="file" accept="application/pdf" />
      <button id="parseFileBtn">Skapa lista från fil</button>
      <span id="status" class="muted"></span>
    </div>
    <div class="toolbar">
      <button id="exportCsvBtn" disabled>Exportera CSV</button>
      <span class="pill"><b>Resultat:</b>&nbsp;Skola · Inriktning · Lägsta Merit</span>
    </div>
  </header>

  <main>
    <table id="outTable" hidden>
      <thead>
        <tr><th>Skola</th><th>Inriktning</th><th>Lägsta Merit</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <details open>
      <summary>Visa debug (första ~500 rader + matcher)</summary>
      <pre id="debugLines"></pre>
    </details>
  </main>

<script type="module">
  import * as pdfjsLib from './vendor/pdfjs/pdf.mjs';
  const worker = new Worker('./vendor/pdfjs/pdf.worker.mjs', { type: 'module' });
  pdfjsLib.GlobalWorkerOptions.workerPort = worker;

  const statusEl = document.getElementById('status');
  const outTable = document.getElementById('outTable');
  const tbody = outTable.querySelector('tbody');
  const debugEl = document.getElementById('debugLines');
  const exportCsvBtn = document.getElementById('exportCsvBtn');

  const norm = s => (s||'').replace(/\s+/g,' ').trim();

  // Tillåt 1–4 siffror + ev. decimal; 0 är giltigt (IV/YI kan ha 0)
  const NUM_RE = /(?<!\d)\d{1,4}(?:[.,]\d+)?(?!\d)/g;
  const getNums = s => Array.from((s||'').matchAll(NUM_RE)).map(m=>parseFloat(m[0].replace(',','.')));

  // Rubriker som bara är “brus”
  const JUNK_LINES = /^(Gymnasieantagningen i Örebro län|Kommunala gymnasieskolor|Fristående gymnasieskolor|\d{2}:\d{2}:\d{2}|period\s+\d+|stv\.)$/i;

  function buildLines(items){
    const rowsByY = new Map(); const yq = 2;
    for(const it of items){
      const y = it.transform[5], x = it.transform[4];
      const key = Math.round(y/yq)*yq;
      if(!rowsByY.has(key)) rowsByY.set(key, []);
      rowsByY.get(key).push({x,str: it.str||''});
    }
    const ys = Array.from(rowsByY.keys()).sort((a,b)=> b-a);
    const lines = [];
    for(const y of ys){
      const bits = rowsByY.get(y).sort((a,b)=> a.x-b.x).map(b=>b.str);
      let line = norm(bits.join(' '));
      if(!line) continue;
      line = line
        .replace(/forsta-?\s*handssokande/gi,'första-handssökande')
        .replace(/Lagsta\s+jamforelsetal/gi,'Lägsta jämförelsetal')
        .replace(/Medianvarde/gi,'Medianvärde')
        .replace(/\bAntal\s+forsta\b/gi,'Antal första')
        .replace(/[‐–—―]/g,'-'); // normalisera bindestreck
      if (JUNK_LINES.test(line)) continue;
      lines.push(line);
    }
    return lines;
  }

  const isSchoolHeader = l => /^Slutlig antagningsstatistik för\s+/i.test(l);
  const extractSchool = l => l.replace(/^Slutlig antagningsstatistik för\s+/i,'').trim();
  const isBareSchool = l => /(skolan|gymnasiet|gymnasium|Idrottsgym)\.?$/i.test(l) && !/\d/.test(l);

  // --- Program-extraktion i två pass ---
  function extractProgramsTwoPass(line){
    const out = [];

    // PASS 1: Programinriktat val … | Yrkesintro. mot …  (till nästa punkt)
    const pass1 = [];
    let tmp = line;
    const RE1 = /(Programinriktat val mot [^.]+\.|Yrkesintro\.\s*mot [^.]+\.)/g;
    tmp = tmp.replace(RE1, m => { pass1.push(norm(m.replace(/\s*\.$/,''))); return ' §CUT§ '; });

    // PASS 2: Övriga “…progr.” (+ ev. specialisering efter bindestreck) – stoppa före nästa progr.
    const RE2 = /\b([A-Za-zÅÄÖåäöÉéÜüÏïÖö\- .]+?progr\.|programmet)\b(?:\s*-\s*(?![A-Za-zÅÄÖåäöÉéÜüÏïÖö\- .]+?progr\.)[A-Za-zÅÄÖåäöÉéÜüÏïÖö\- .]+)?/g;
    const pass2 = [];
    let m2;
    while((m2 = RE2.exec(tmp))!==null){
      pass2.push(norm(m2[0].replace(/\bprogrammet\b/i,'progr.')));
    }

    // Rensa dubbletter, kasta triviala reststrängar
    const uniq = new Set();
    for(const s of [...pass1, ...pass2]){
      const clean = s.replace(/^Studieväg\s*/i,'').trim();
      if(clean && !uniq.has(clean)){ uniq.add(clean); out.push(clean); }
    }
    return out;
  }

  // Label-detektion
  const LAB_LAGSTA = /Lägsta\s+jämförelsetal/i;
  const LAB_STUDIEVAG = /^Studieväg$/i;
  const LAB_ANY = /(Antal platser|Antal första-?handssökande|Antal antagna|Lägsta\s+jämförelsetal|Medianvärde|Antal reserver|Studieväg)/i;

  async function parsePdfFromArrayBuffer(buf){
    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
    const allRows = [];
    const debug = [];

    let currentSchool = null;

    // Program/merit per block (efter "Studieväg" → "Lägsta …")
    let currentBlockProgs = [];
    let lagstaQueue = [];
    let collectingLagsta = false;
    let insideProgBlock = false;

    function flushPairing(reason=''){
      if(currentSchool && currentBlockProgs.length && lagstaQueue.length){
        // Om längderna skiljer: anta att meritlistan ofta är lika lång eller längre; ta min-längd
        const n = Math.min(currentBlockProgs.length, lagstaQueue.length);
        for(let i=0;i<n;i++){
          allRows.push([currentSchool, currentBlockProgs[i], lagstaQueue[i]]);
        }
        debug.push(`  [MATCH] ${n} rader → ${currentSchool}${reason?(' | '+reason):''}`);
      }else if(currentSchool && currentBlockProgs.length && !lagstaQueue.length){
        debug.push(`  [WARN] ${currentSchool}: program utan LÄGSTA (${currentBlockProgs.length})${reason?(' | '+reason):''}`);
      }else if(currentSchool && lagstaQueue.length && !currentBlockProgs.length){
        debug.push(`  [WARN] ${currentSchool}: LÄGSTA utan program (${lagstaQueue.length})${reason?(' | '+reason):''}`);
      }
      currentBlockProgs = [];
      lagstaQueue = [];
      collectingLagsta = false;
      insideProgBlock = false;
    }

    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const text = await page.getTextContent();
      const lines = buildLines(text.items);

      lines.slice(0,40).forEach(L => { if (debug.length<700) debug.push(L); });

      for(let i=0;i<lines.length;i++){
        const L = lines[i];

        // Ny skola → flush förra blocket
        if(isSchoolHeader(L)){
          flushPairing('ny [Slutlig antagningsstatistik för]');
          currentSchool = extractSchool(L);
          debug.push(`[SKOLA] ${currentSchool}`);
          continue;
        }
        if(isBareSchool(L)){
          flushPairing('ny [skolrad]');
          currentSchool = L.trim();
          debug.push(`[SKOLA] ${currentSchool}`);
          continue;
        }

        // Labeler
        if(LAB_ANY.test(L)){
          if(LAB_STUDIEVAG.test(L)){
            // starta programblock
            insideProgBlock = true;
            currentBlockProgs = [];
          } else if (LAB_LAGSTA.test(L)){
            // starta LÄGSTA-insamling
            collectingLagsta = true;
            lagstaQueue = [];
            debug.push(`  [LAGSTA] start`);
          } else {
            // annan label stänger ev. pågående LÄGSTA → para nu
            if(collectingLagsta){
              collectingLagsta = false;
              flushPairing('slut på LÄGSTA-block');
            }
            // annan label stänger inte programblock per se (program kommer före LÄGSTA),
            // men om vi lämnar programdelen och senare inte ser LÄGSTA alls, flushas vid skola/EOF.
          }
          continue;
        }

        // Samla meriter
        if(collectingLagsta){
          const nums = getNums(L);
          if(nums.length) lagstaQueue.push(...nums);
          // kodrad (AE/DEM/…) → stäng blocket och para
          if(/^(?:[A-ZÅÄÖ]{2,3}\s+){3,}[A-ZÅÄÖ]{2,3}$/.test(L)){
            collectingLagsta = false;
            flushPairing('kodrad (AE/DEM/…)');
          }
          continue;
        }

        // Samla program (bara när vi är i programblocket efter "Studieväg")
        if(insideProgBlock && currentSchool){
          const progs = extractProgramsTwoPass(L);
          if(progs.length) currentBlockProgs.push(...progs);
        }
      }
    }

    // slutet av sista sida
    flushPairing('EOF');

    debug.push(`--- Totalt extraherade rader: ${allRows.length}`);
    debugEl.textContent = debug.join('\n');
    return allRows;
  }

  function renderRows(rows){
    tbody.innerHTML = '';
    rows.sort((a,b)=> (a[0]===b[0] ? a[1].localeCompare(b[1],'sv') : a[0].localeCompare(b[0],'sv')));
    for(const [skola,inr,lag] of rows){
      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.textContent = skola; tr.appendChild(td1);
      const td2 = document.createElement('td'); td2.textContent = inr;   tr.appendChild(td2);
      const td3 = document.createElement('td'); td3.textContent = (typeof lag==='number'? String(lag).replace('.',',') : String(lag)); tr.appendChild(td3);
      tbody.appendChild(tr);
    }
    outTable.hidden = rows.length === 0;
    statusEl.textContent = `Klar — ${rows.length} rader`;
    exportCsvBtn.disabled = rows.length === 0;
    exportCsvBtn.onclick = () => exportCSV(rows);
  }

  function exportCSV(rows){
    const header = ['Skola','Inriktning','Lägsta Merit'];
    const esc = s => `"${String(s).replace(/"/g,'""')}"`;
    const fmt = v => (typeof v === 'number' ? String(v).replace('.', ',') : String(v));
    const delimiter = ';';
    const body = rows.map(([a,b,c]) => [esc(a), esc(b), esc(fmt(c))].join(delimiter));
    const csv = [header.map(esc).join(delimiter), ...body].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'antagning_orebro_2025.csv';
    document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
  }

  document.getElementById('parseFileBtn').addEventListener('click', async () => {
    const f = document.getElementById('pdfFile').files[0];
    if(!f){ alert('Välj en PDF-fil först.'); return; }
    statusEl.textContent = 'Läser PDF…';
    outTable.hidden = true; exportCsvBtn.disabled = true;
    try{
      const rows = await parsePdfFromArrayBuffer(await f.arrayBuffer());
      renderRows(rows);
    }catch(err){
      console.error(err);
      statusEl.textContent = 'Fel vid parsning: ' + err.message;
    }
  });

  // Tysta TT-varningen
  try{
    if (pdfjsLib.VerbosityLevel) pdfjsLib.GlobalWorkerOptions.verbosity = pdfjsLib.VerbosityLevel.ERROR;
    const o = console.warn;
    console.warn = (...args) => { if (String(args[0]||'').includes('TT: undefined function')) return; o(...args); };
  }catch{}
</script>
</body>
</html>
