<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Slutlig antagning – parser (filuppladdning)</title>
  <style>
    :root{ --bg:#0b0f14; --fg:#e7effa; --muted:#94a3b8; --panel:#0f172a; --accent:#22c55e; --border:#1f2937; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
    header{padding:16px 20px;background:#0f172a;border-bottom:1px solid var(--border)}
    main{max-width:1100px;margin:0 auto;padding:20px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type=file]{flex:1;min-width:260px;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0f172a;color:var(--fg)}
    button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#05280f;font-weight:700;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:20px;background:#0f172a;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{background:#0d1326;position:sticky;top:112px}
    tr:hover td{background:#0c1222}
    .muted{color:var(--muted)}
    details{margin-top:14px}
    pre{white-space:pre-wrap;font-size:12px;background:#0f172a;border:1px solid var(--border);padding:10px;border-radius:8px;max-height:320px;overflow:auto}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <input id="pdfFile" type="file" accept="application/pdf" />
      <button id="parseFileBtn">Skapa lista från fil</button>
      <span id="status" class="muted"></span>
    </div>
    <div class="muted" style="margin-top:8px">
      Resultat: <b>Skola</b> · <b>Inriktning</b> · <b>Lägsta Merit</b>
    </div>
  </header>

  <main>
    <table id="outTable" hidden>
      <thead>
        <tr><th>Skola</th><th>Inriktning</th><th>Lägsta Merit</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <details>
      <summary>Visa debug (första ~80 byggda rader)</summary>
      <pre id="debugLines"></pre>
    </details>
  </main>

  <script type="module">
    // Justera paths vid behov:
    import * as pdfjsLib from './vendor/pdfjs/pdf.mjs';
    const worker = new Worker('./vendor/pdfjs/pdf.worker.mjs', { type: 'module' });
    pdfjsLib.GlobalWorkerOptions.workerPort = worker;

    const statusEl = document.getElementById('status');
    const outTable = document.getElementById('outTable');
    const tbody = outTable.querySelector('tbody');
    const debugEl = document.getElementById('debugLines');

    const MARKER_ANY = 'Slutlig antagningsstatistik';   // "för" kan brytas i PDF
    const STUDIEVAG = 'Studieväg';
    const LOWEST_HDR = 'Lägsta jämförelsetal';

    const NORM_RE = /\s+/g;
    const norm = s => (s||'').replace(NORM_RE,' ').trim();
    const isMostlyNumbers = s => /^(\d|[.,]|\s)+$/.test(s.trim());

    // Gruppér textbitar till rader via y/x
    function itemsToLines(items){
      const rows = new Map();
      const yQuant = 2;
      for(const it of items){
        const t = it.transform, y=t[5], x=t[4];
        const key = Math.round(y / yQuant) * yQuant;
        if(!rows.has(key)) rows.set(key, []);
        rows.get(key).push({ x, str: it.str });
      }
      const ys = Array.from(rows.keys()).sort((a,b)=> b-a);
      const lines = [];
      for(const y of ys){
        const bits = rows.get(y).sort((a,b)=> a.x - b.x).map(b=>b.str);
        const line = norm(bits.join(' '));
        if(line) lines.push(line);
      }
      return lines;
    }

    // Heuristik: skolnamn
    function detectSchool(line){
      // 1) Om raden innehåller markören, ta texten före
      if(line.includes(MARKER_ANY)){
        const before = line.split(MARKER_ANY)[0].trim();
        const cleaned = before.replace(/[^A-Za-zÅÄÖåäöÉéÜüÏïÖö \-\.]/g,'').trim();
        if(cleaned) return cleaned;
      }
      // 2) Annars: ren skolrad (t.ex. "Alléskolan", "...gymnasiet")
      if(/(skolan|skolan\.|gymnasiet|gymnasiet\.|gymnasium)$/i.test(line) || /^[A-ZÅÄÖ].{2,}$/.test(line) ){
        // Begränsa till "rimlig" längd och inga uppenbara sifferrader
        if(line.length <= 60 && !/\d/.test(line)) return line;
      }
      return null;
    }

    // Rensa PDF-artefakter
    function fixSplits(s){
      return s.replace(/\u00AD/g,'')
              .replace(/\boc h\b/gi,'och')
              .replace(/\s-\s+/g,' - ')
              .replace(/\s{2,}/g,' ')
              .trim();
    }

    // Plocka ut alla programnamn ur en sammansatt Studieväg-text
    function extractProgramsFromStudievag(text){
      const t = fixSplits(text);
      const matches = [];
      const re = new RegExp(
        [
          // Programinriktat val mot ...progr. (ev. "- Transport" variant)
          '(Programinriktat val mot [A-Za-zÅÄÖåäöÉéÜüÏïÖö\\- och\\.]+?progr(?:\\.- Transport)?\\.)',
          // Yrkesintro. mot ...progr.
          '(Yrkesintro\\.\\s*mot [A-Za-zÅÄÖåäöÉéÜüÏïÖö\\- och\\.]+?progr(?:\\.- Transport)?\\.)',
          // Vanliga program, slutar på "progr." eller förkortat "pr."
          '([A-ZÅÄÖa-zåäöÉéÜüÏïÖö\\- ]+?progr\\.|[A-ZÅÄÖa-zåäöÉéÜüÏïÖö\\- ]+?pr\\.)'
        ].join('|'),
        'g'
      );
      let m;
      while((m = re.exec(t)) !== null){
        const hit = (m[1] || m[2] || m[3] || '').trim();
        if(hit){
          // Städa "pr." -> "progr." om det ser ut som förkortat program
          const cleaned = hit
            .replace(/\bpr\.\b/g,'progr.')
            .replace(/programmet/gi,'progr.')
            .replace(/\s{2,}/g,' ')
            .trim();
          matches.push(cleaned);
        }
      }
      // Filtrera bort ensamma "stv."/skräp
      return matches.filter(s => !/^stv\.?$/i.test(s));
    }

    // Samla merit-lista (decimaltal) efter "Lägsta jämförelsetal"
    function collectMerits(lines, startIdx){
      const vals = [];
      for(let i=startIdx+1; i<lines.length; i++){
        const L = lines[i];
        if(!isMostlyNumbers(L)) break;
        const nums = Array.from(L.matchAll(/\b\d{1,3}(?:[.,]\d+)?\b/g))
                          .map(m => parseFloat(m[0].replace(',','.')))
                          .filter(v => v>=0 && v<=340);
        vals.push(...nums);
      }
      return vals;
    }

    async function parseCommon(pdf){
      let currentSchool = null;
      let pendingSchool = null;
      let programs = [];
      let merits = [];
      const out = [];
      const debug = [];

      function flush(){
        if(currentSchool && programs.length && merits.length){
          const n = Math.min(programs.length, merits.length);
          for(let i=0;i<n;i++){
            out.push([currentSchool, programs[i], merits[i]]);
          }
        }
        programs = [];
        merits = [];
      }

      for(let p=1; p<=pdf.numPages; p++){
        const page = await pdf.getPage(p);
        const textContent = await page.getTextContent();
        const lines = itemsToLines(textContent.items);

        // debug-lagring
        for(const L of lines){
          if(debug.length<80) debug.push(L);
        }

        for(let i=0;i<lines.length;i++){
          const lineRaw = lines[i];
          const line = norm(lineRaw);

          // Skolnamn
          const maybe = detectSchool(line);
          if(maybe){
            // Om vi redan har data för förra skolan: flush
            if(currentSchool && (programs.length || merits.length)) flush();
            // Sätt preliminärt – bekräftas av att vi senare stöter på MARKER_ANY,
            // men i många PDF:er är detta redan rätt (exv. "Alléskolan").
            pendingSchool = maybe;
          }
          if(line.includes(MARKER_ANY)){
            // Bekräfta skolnamn
            currentSchool = pendingSchool || currentSchool;
          }

          // Studieväg – samla program
          if(line.startsWith(STUDIEVAG)){
            // samla ihop allt program-text på samma "block" (nuvarande rad + ev. följande rader
            // som innehåller "progr."/"Yrkesintro." etc.) tills vi träffar nästa rubrik/nummerblock
            let block = '';
            for(let j=i+1; j<lines.length; j++){
              const L = lines[j];
              if(/Antal|Medianvärde|Lägsta jämförelsetal|Sydnärkes|Studieväg|Slutlig antagningsstatistik/i.test(L)) break;
              // heuristiskt: ta rader som innehåller "progr" eller "Yrkesintro" eller ser ut som sammanslagna programlistor
              if(/progr|Yrkesintro|Programinriktat val/i.test(L) || / [A-ZÅÄÖ].+progr\./.test(L)){
                block += ' ' + L;
              } else {
                // Om raden är tydligt siffror/metadata – avsluta blocket
                if(isMostlyNumbers(L)) break;
              }
            }
            const extracted = extractProgramsFromStudievag(block);
            if(extracted.length) programs.push(...extracted);
          }

          // Lägsta jämförelsetal – samla merits
          if(line.startsWith(LOWEST_HDR)){
            const vals = collectMerits(lines, i);
            if(vals.length) merits.push(...vals);
          }
        }
      }

      // sista flush
      if(currentSchool && (programs.length || merits.length)) flush();

      debugEl.textContent = debug.join('\n');
      return out;
    }

    async function parsePdfFromArrayBuffer(buf){
      const loadingTask = pdfjsLib.getDocument({ data: buf });
      const pdf = await loadingTask.promise;
      return parseCommon(pdf);
    }

    function renderRows(rows){
      tbody.innerHTML = '';
      rows.sort((a,b)=> (a[0]===b[0] ? a[1].localeCompare(b[1]) : a[0].localeCompare(b[0])));
      for(const [skola,inr,lag] of rows){
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.textContent = skola; tr.appendChild(td1);
        const td2 = document.createElement('td'); td2.textContent = inr;   tr.appendChild(td2);
        const td3 = document.createElement('td'); td3.textContent = (typeof lag==='number' ? lag.toString() : lag); tr.appendChild(td3);
        tbody.appendChild(tr);
      }
      outTable.hidden = false;
      statusEl.textContent = `Klar — ${rows.length} rader`;
    }

    document.getElementById('parseFileBtn').addEventListener('click', async () => {
      const f = document.getElementById('pdfFile').files[0];
      if(!f){ alert('Välj en PDF-fil först.'); return; }
      statusEl.textContent = 'Läser PDF…';
      outTable.hidden = true;
      try{
        const buf = await f.arrayBuffer();
        const rows = await parsePdfFromArrayBuffer(buf);
        renderRows(rows);
      }catch(err){
        console.error(err);
        statusEl.textContent = 'Fel vid parsning: ' + err.message;
      }
    });
  </script>
</body>
</html>
