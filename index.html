<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>PDF-text → CSV (Skola;Program;Lägsta Merit)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f14;--fg:#e7effa;--muted:#94a3b8;--panel:#0f172a;--accent:#22c55e;--border:#1f2937;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1000px;margin:0 auto;padding:20px}
    h1{font-size:1.3rem;margin:0 0 10px}
    p{color:var(--muted);margin:.4rem 0}
    textarea{width:100%;height:45vh;background:#0e1522;color:var(--fg);border:1px solid var(--border);
      border-radius:10px;padding:12px;font-size:.95rem;line-height:1.35;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 4px}
    button{background:var(--accent);border:none;color:#062a14;padding:10px 14px;border-radius:10px;
      font-weight:700;cursor:pointer}
    button.secondary{background:#1f2937;color:#e5e7eb}
    .out{white-space:pre; background:#0e1522;border:1px dashed var(--border);border-radius:10px;padding:12px;margin-top:10px}
    .stat{font-variant-numeric:tabular-nums}
    .chip{display:inline-block;background:#132033;border:1px solid var(--border);color:var(--muted);
      padding:2px 8px;border-radius:999px;font-size:.8rem;margin-left:6px}
    a.dl{color:#9ae6b4}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>PDF-text → CSV <span class="chip">Skola;Program;Lägsta&nbsp;Merit</span></h1>
    <p>Steg: öppna PDF · Ctrl+A · Ctrl+C · klistra här · klicka “Extrahera → CSV”.</p>

    <textarea id="inp" placeholder="Klistra in all text kopierad ur PDF:en här..."></textarea>

    <div class="row">
      <button id="btn">Extrahera → CSV</button>
      <button id="btnCopy" class="secondary" title="Kopiera CSV till urklipp">Kopiera CSV</button>
      <a id="dl" class="dl secondary" download="lagsta_merit.csv" style="display:none">Ladda ner CSV</a>
    </div>

    <div id="report" class="out" hidden></div>
  </div>

<script>
(function(){
  const ta = document.getElementById('inp');
  const btn = document.getElementById('btn');
  const btnCopy = document.getElementById('btnCopy');
  const dl = document.getElementById('dl');
  const report = document.getElementById('report');

  function cleanLine(s){
    return s.replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim();
  }

  function parse(text){
    const lines = text.split(/\r?\n/).map(cleanLine).filter(Boolean);

    let school = null;
    const rows = [];

    // regex för skolrubrik
    const reSchool = /^Slutlig antagningsstatistik för\s+(.+)$/i;

    // regex för datarader: <program> <KOD> platser förstahand antagna LÄGSTA ...
    // Vi plockar fjärde talet efter koden som "Lägsta".
    const reData = /^(?<prog>.+?)\s+[A-ZÅÄÖ]{2,3}\s+\d+\s+\d+\s+\d+\s+(?<lagsta>\d+(?:\.\d+)?)(?:\s+\d+(?:\.\d+)?)?/;

    // hoppa över dessa "rubrik"-rader
    const skipTokens = new Set([
      'Gymnasieantagningen i Örebro län',
      'Kommunala gymnasieskolor',
      'Fristående gymnasieskolor',
      'Antal första- Antal Lägsta Studieväg Antal platser handssökande antagna jämförelsetal Medianvärde Antal reserver',
      'Antal första- Antal Lägsta',
      'Studieväg Antal platser handssökande antagna jämförelsetal Medianvärde Antal reserver'
    ]);

    for (let raw of lines){
      if (skipTokens.has(raw)) continue;

      const mSchool = raw.match(reSchool);
      if (mSchool){
        school = mSchool[1].trim();
        continue;
      }

      if (!school) continue; // tills vi sett första skola

      // Sidor/”stv.”/sidräknare: hoppa över korta tokens som bara är siffror/”st.v”
      if (/^\d+$/.test(raw) || /\bstv\.\b/i.test(raw)) continue;

      const m = raw.match(reData);
      if (m){
        const prog = m.groups.prog
          .replace(/\s{2,}/g,' ')
          .replace(/\s-\s/g,' - ')
          .trim();
        const lagsta = m.groups.lagsta;
        rows.push([school, prog, lagsta]);
      }
    }

    return rows;
  }

  function toCSV(rows){
    const esc = v => (
      /[;"\n]/.test(v) ? `"${String(v).replace(/"/g,'""')}"` : v
    );
    const out = [['Skola','Program','Lägsta Merit'], ...rows].map(r => r.map(esc).join(';')).join('\n');
    return out + '\n';
  }

  function showReport(rows){
    report.hidden = false;
    report.innerHTML =
      `Rader hittade: <b class="stat">${rows.length}</b>\n` +
      (rows.slice(0,10).map(r => `• ${r[0]} · ${r[1]} · ${r[2]}`).join('\n') || '(inget hittat)') +
      (rows.length>10?`\n… (${rows.length-10} fler)`:'');
  }

  btn.addEventListener('click', ()=>{
    const text = ta.value||'';
    const rows = parse(text);
    showReport(rows);
    const csv = toCSV(rows);

    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    dl.href = url;
    dl.download = 'lagsta_merit.csv';
    dl.style.display = 'inline-block';
    dl.textContent = 'Ladda ner CSV';
    dl.onclick = ()=> setTimeout(()=>URL.revokeObjectURL(url), 1000);

    btnCopy.onclick = async ()=>{
      try{
        await navigator.clipboard.writeText(csv);
        btnCopy.textContent = 'Kopierat!';
        setTimeout(()=>btnCopy.textContent='Kopiera CSV',1200);
      }catch(e){
        alert('Kunde inte kopiera till urklipp.');
      }
    };
  });
})();
</script>
</body>
</html>
