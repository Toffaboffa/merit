<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Slutlig antagning — PDF → Lista</title>
<style>
  :root{--bg:#0b0f14;--fg:#e7effa;--muted:#9fb1c8;--panel:#0f172a;--accent:#22c55e;--border:#1f2937;--err:#ef4444}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  h1{font-size:1.1rem;margin:0 0 10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  textarea{width:100%;min-height:46vh;background:#0b1220;color:var(--fg);border:1px solid var(--border);border-radius:8px;padding:10px;line-height:1.3;white-space:pre}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  button{background:var(--panel);color:var(--fg);border:1px solid var(--border);border-radius:8px;padding:8px 12px;cursor:pointer}
  button.primary{background:var(--accent);color:#08210f;border:0}
  button.danger{background:var(--err);color:white;border:0}
  table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:10px;overflow:hidden}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:top}
  th{background:#0c1527;text-align:left}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
  details{margin-top:12px}
  pre{background:#0b1220;border:1px solid var(--border);border-radius:8px;padding:10px;overflow:auto;max-height:45vh}
  .stat{margin:6px 0 12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Slutlig antagning Örebro län — skapa lista</h1>

  <div class="row">
    <div>
      <label class="muted">Klistra in texten från PDF-extraktet här:</label>
      <textarea id="src" placeholder="Klistra in hela textdumpen från PDF:en här..."></textarea>
      <div class="btns">
        <button class="primary" id="go">Skapa lista</button>
        <button id="csv">Exportera CSV</button>
        <button class="danger" id="clear">Töm</button>
      </div>
      <div id="stat" class="stat"></div>
      <details id="dbgWrap">
        <summary>Visa debug</summary>
        <pre id="dbg" class="mono"></pre>
      </details>
    </div>

    <div>
      <table id="tbl">
        <thead><tr><th>Skola</th><th>Inriktning</th><th>Lägsta merit</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const el = s => document.querySelector(s);
const tblBody = el('#tbl tbody');
const dbg = el('#dbg');
const stat = el('#stat');

function norm(s){
  if(!s) return "";
  // Normalisera radslut men behåll radbrytningar (viktigt!)
  s = s.replace(/\r\n?/g, '\n');

  // Normalisera olika bindestreck/minustecken → '-'
  s = s.replace(/[-\u2010\u2011\u2012\u2013\u2014\u2015\u2212]/g, '-');

  // Normalisera mellanrum men bevara nya rader
  // 1) Ta bort dubbla spaces inom rad
  s = s.split('\n').map(line => line.replace(/[ \t]+/g,' ').trim()).join('\n');

  // Korrigera kända ihopdragningar från PDF (exempel: "Studieväg" ska stå på egen rad)
  s = s.replace(/(Studieväg)\s*/g, '\n$1\n');

  // Säkerställ att "Slutlig antagningsstatistik för" står på egen rad
  s = s.replace(/Slutlig antagningsstatistik för/g, '\nSlutlig antagningsstatistik för\n');

  // Ta bort tomrads-spam
  s = s.replace(/\n{3,}/g, '\n\n');

  return s.trim();
}

function isLikelySchool(line){
  // Heuristik: skolnamn är ofta egen rad med ord + ev. "gymnasiet/Gy/gymnasiu(m)"
  // och INTE helt numerisk, och INTE rubriker.
  if(!line) return false;
  if(/^(Studieväg|Kommunala|Fristående|Gymnasieantagningen|Antal|Medianvärde|Lägsta jämförelsetal|Slutlig|period|stv\.)/i.test(line)) return false;
  if(/^\d+([.:]\d+)?$/.test(line)) return false;
  if(line.length < 2) return false;
  // Vanliga skolord
  if(/\b(gymnasiet|gymnasium|gymnasiu|gym|Gy|skolan|skola|Idrottsgym)\b/i.test(line)) return true;
  // Namn som Alléskolan, Lindeskolan etc.
  if(/\b(skolan|skola|Alléskolan|Lindeskolan|Pihlskolan|Rudbecksgymnasiet|Karolinska|Virginska|Tullängsgymnasiet|Möckelngymnasiet|Degerforsgymnasiet|Affärsgymnasiet|Grillska|Jensen|LBS|NTI|Praktiska|Realgymnasiet|Rytmus|Yrkesgymnasiet|Karlskoga Idrottsgym)\b/i.test(line)) return true;
  // Fallback: kapitaliserad rad utan punkt
  if(/^[A-ZÅÄÖ].{2,}$/.test(line) && !/[.:]$/.test(line)) return true;
  return false;
}

function extractBlocks(text){
  const lines = text.split('\n');
  const blocks = [];
  for(let i=0;i<lines.length;i++){
    if(lines[i].trim() === 'Slutlig antagningsstatistik för'){
      // Hitta skolnamn runt den här positionen (upp till 5 rader upp eller 3 ner)
      let school = null;
      for(let k=1;k<=5;k++){
        const cand = (lines[i-k]||'').trim();
        if(isLikelySchool(cand)){ school = cand; break; }
      }
      if(!school){
        for(let k=1;k<=3;k++){
          const cand = (lines[i+k]||'').trim();
          if(isLikelySchool(cand)){ school = cand; break; }
        }
      }

      // 1) Läs programlistan tills vi når "Studieväg"
      const progs = [];
      let j = i+1;
      while(j < lines.length && lines[j].trim() !== 'Studieväg'){
        const t = lines[j].trim();
        if(t && !/^(Antal|Medianvärde|Lägsta jämförelsetal|stv\.|period|Gymnasieantagningen|Kommunala|Fristående|\d{2}:\d{2}:\d{2})/i.test(t)){
          progs.push(t);
        }
        j++;
      }
      // hoppa över raden "Studieväg"
      while(j < lines.length && lines[j].trim() === '') j++;
      if(j < lines.length && lines[j].trim() === 'Studieväg') j++;

      // 2) Hitta blocket "Lägsta jämförelsetal" efter detta och samla alla tal
      let m = j;
      // sök framåt efter markören
      while(m < lines.length && lines[m].trim() !== 'Lägsta jämförelsetal') m++;

      const merits = [];
      if(m < lines.length && lines[m].trim() === 'Lägsta jämförelsetal'){
        m++;
        // Samla tills nästa rubrik (Antal antagna / Medianvärde / Antal första-handssökande / Antal platser)
        let buf = '';
        while(m < lines.length){
          const t = lines[m].trim();
          if(/^((Antal (antagna|platser|första-?handssökande))|Medianvärde|Slutlig antagningsstatistik för|[A-ZÅÄÖ].*gym)/i.test(t)) break;
          buf += ' ' + t;
          m++;
        }
        // Plocka tal (tillåt , eller .)
        const nums = buf.match(/-?\d+(?:[.,]\d+)?/g) || [];
        for(const s of nums){
          const v = parseFloat(s.replace(',', '.'));
          // Låt 0 följa med (v === 0 ok), ignorera NaN
          if(!Number.isNaN(v)) merits.push(v);
        }
      }

      blocks.push({school, progs, merits});
    }
  }
  return blocks;
}

function pairRows(blocks){
  const rows = [];
  const warnings = [];
  for(const b of blocks){
    if(!b.school) { warnings.push('[WARN] Kunde inte hitta skolnamn för en sektion.'); continue; }

    // Städa programlistan: slå ihop ev. rader som PDF brutit konstigt (heuristik)
    // Ex: "Estetiska progr. - Estetik och media Estetiska progr. - Musik Fordons..."
    // Vi splittrar vid "  " (dubbelt blanksteg) eller när ett nytt program börjar (ord som slutar på "progr." etc.)
    const reNewProg = /\b((Estetiska|Naturvetenskaps|Samhällsvetenskaps|Ekonomi|Teknik|El - och energi|Bygg - och anläggnings|Vård - och omsorgs|Industritekniska|Fordons - och transport|Hotell - och turism|Barn - och fritids|Naturbruks|Yrkesintro\.|Programinriktat val))\b/i;

    // Finare: försök dela genom att leta efter "  " (dubbelblank) som PDF ofta lämnar mellan studievägar
    let concat = b.progs.join(' ').replace(/\s{2,}/g,' • ');
    // Om vi fortfarande inte får "•", lägg in markör före kända prefix
    concat = concat.replace(/\s(?=(Estetiska|Naturvetenskaps|Samhällsvetenskaps|Ekonomiprogr\.|Teknikprogr\.|El - och energi|Bygg - och anläggnings|Vård - och omsorgs|Industritekniska|Fordons - och transport|Hotell - och turism|Barn - och fritids|Naturbruks|Yrkesintro\.|Programinriktat val))/g, ' • ');
    let progList = concat.split('•').map(s=>s.trim()).filter(Boolean);

    // Sanera dubbleringar + ta bort ensamma markörer
    progList = progList.filter(x => !/^(Studieväg|stv\.|period|Gymnasieantagningen)/i.test(x));

    // Parning
    const n = Math.min(progList.length, b.merits.length);
    if(n === 0){
      warnings.push(`[WARN] Noll parningar för ${b.school} (progs=${progList.length}, merits=${b.merits.length})`);
      continue;
    }
    for(let i=0;i<n;i++){
      rows.push({school:b.school, program:progList[i], merit:b.merits[i]});
    }
    if(progList.length !== b.merits.length){
      warnings.push(`[WARN] Olika antal för ${b.school}: progs=${progList.length} vs merits=${b.merits.length} — tog min(${n}).`);
    }
  }
  return {rows, warnings};
}

function render(rows){
  // rensa
  tblBody.innerHTML = '';
  // sortera alfabetiskt skola → program
  rows.sort((a,b)=> (a.school||'').localeCompare(b.school||'','sv') || (a.program||'').localeCompare(b.program||'','sv'));
  for(const r of rows){
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent = r.school || '';
    const td2 = document.createElement('td'); td2.textContent = r.program || '';
    const td3 = document.createElement('td'); td3.textContent = (r.merit ?? '').toString().replace('.', ',');
    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
    tblBody.appendChild(tr);
  }
  stat.textContent = `Klar — ${rows.length} rader`;
}

function toCSV(rows){
  const esc = s => `"${(s??'').toString().replace(/"/g,'""')}"`;
  const lines = [['Skola','Inriktning','Lägsta Merit'].map(esc).join(',')];
  for(const r of rows){
    lines.push([esc(r.school), esc(r.program), esc((r.merit ?? '').toString().replace('.',','))].join(','));
  }
  return lines.join('\n');
}

// UI handlers
let LAST_ROWS = [];
el('#go').addEventListener('click', ()=>{
  const raw = el('#src').value;
  const txt = norm(raw);
  const blocks = extractBlocks(txt);
  const {rows, warnings} = pairRows(blocks);
  LAST_ROWS = rows;
  render(rows);
  // Debug: visa första ~7000 tecken + match-översikt
  const preview = txt.slice(0,7000);
  const matchInfo = [
    `--- DEBUG ---`,
    `Sektioner funna: ${blocks.length}`,
    ...blocks.map(b => `[SKOLA] ${b.school||'(okänd)'} | progs=${b.progs.length} | merits=${b.merits.length}`),
    ...(warnings.length ? ['--- VARNINGAR ---', ...warnings] : []),
    '--- TEXT PREVIEW ---',
    preview
  ].join('\n');
  dbg.textContent = matchInfo;
});

el('#csv').addEventListener('click', ()=>{
  if(!LAST_ROWS.length){ alert('Inget att exportera än. Kör "Skapa lista" först.'); return; }
  const csv = toCSV(LAST_ROWS);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lagsta-merit.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

el('#clear').addEventListener('click', ()=>{
  el('#src').value = '';
  tblBody.innerHTML = '';
  stat.textContent = '';
  dbg.textContent = '';
});
</script>
</body>
</html>
